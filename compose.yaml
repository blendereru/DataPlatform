version: "3.9"

services:

  # ======================================
  #  SQL SERVER 2022 (LATEST)
  # ======================================
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "Your_Strong_Password123!"
    ports:
      - "1434:1433"
    volumes:
      - sql_data:/var/opt/mssql
    healthcheck:
      test: ["CMD", "/opt/mssql-tools/bin/sqlcmd",
             "-S", "localhost", "-U", "sa", "-P", "Your_Strong_Password123!",
             "-Q", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  # ======================================
  #  RABBITMQ 4.x (LATEST)
  # ======================================
  rabbitmq:
    image: rabbitmq:4.0-management
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10

  # ======================================
  #  ELASTICSEARCH 8.15.x
  # ======================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.2
    container_name: elasticsearch
    environment:
      discovery.type: single-node
      xpack.security.enabled: "false"
      xpack.security.http.ssl.enabled: "false"
      ES_JAVA_OPTS: "-Xms1g -Xmx1g"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - esdata:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200"]
      interval: 10s
      timeout: 5s
      retries: 20

  # ======================================
  #  KIBANA 8.15.x
  # ======================================
  kibana:
    image: docker.elastic.co/kibana/kibana:8.15.2
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      ELASTICSEARCH_HOSTS: "http://elasticsearch:9200"
    depends_on:
      - elasticsearch

  # ======================================
  #  ASP.NET DATA PLATFORM API
  # ======================================
  dataplatform-api:
    container_name: dataplatform-api
    build:
      context: .
      dockerfile: DataPlatform.Api/Dockerfile
    ports:
      - "8080:8080"
      - "8081:8081"
    environment:

      ASPNETCORE_URLS: "http://+:8080"
      ASPNETCORE_ENVIRONMENT: "Production"

      # ---------------- SQL SERVER CONFIG ----------------
      ConnectionStrings__DefaultConnection: "Server=sqlserver;Database=DataPlatform;User=sa;Password=Your_Strong_Password123!;TrustServerCertificate=True;"

      # ---------------- RABBITMQ CONFIG ------------------
      RabbitMq__Host: "rabbitmq"
      RabbitMq__Username: "guest"
      RabbitMq__Password: "guest"

      # ---------------- ELASTICSEARCH LOGGING ------------
      Serilog__WriteTo__1__Args__nodeUris: "http://elasticsearch:9200"

    depends_on:
      sqlserver:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy

volumes:
  sql_data:
  esdata: